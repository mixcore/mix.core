"use strict";
var app = angular.module("MixInit", [
  "ui.bootstrap",
  "ngRoute",
  "ngFileUpload",
  "LocalStorageModule",
  "components",
  "MixShared",
]);
var modules = angular.module("components", []);

app.config(function ($routeProvider, $locationProvider, $sceProvider) {
  $locationProvider.html5Mode(true);

  $routeProvider.when("/init", {
    controller: "Step1Controller",
    templateUrl: "/mix-app/views/app-init/pages/step1/index.html",
  });

  $routeProvider.when("/init/step2", {
    controller: "Step2Controller",
    templateUrl: "/mix-app/views/app-init/pages/step2/view.html",
  });
  $routeProvider.when("/init/step3", {
    controller: "Step3Controller",
    templateUrl: "/mix-app/views/app-init/pages/step3/view.html",
  });
  $routeProvider.when("/init/step4", {
    controller: "Step4Controller",
    templateUrl: "/mix-app/views/app-init/pages/step4/view.html",
  });
  $routeProvider.when("/init/step5", {
    controller: "Step5Controller",
    templateUrl: "/mix-app/views/app-init/pages/step5/view.html",
  });
  $routeProvider.otherwise({
    redirectTo: "/init",
  });
});

"use strict";
app.controller("Step1Controller", [
  "$scope",
  "$rootScope",
  "localStorageService",
  "CommonService",
  "ApiService",
  "Step1Services",
  function (
    $scope,
    $rootScope,
    localStorageService,
    commonService,
    apiService,
    step1Services
  ) {
    var rand = Math.floor(Math.random() * 10000) + 1;
    $scope.settings = {
      providers: [
        {
          text: "MySQL Database",
          value: "MySQL",
          port: "3306",
          img: "/mix-app/assets/img/mysql.jpg",
        },
        {
          text: "Microsoft SQL Server Database",
          value: "SQLSERVER",
          port: null,
          img: "/mix-app/assets/img/mssql.jpg",
        },
        {
          text: "PostgreSQL Database",
          value: "PostgreSQL",
          port: "5432",
          img: "/mix-app/assets/img/postgresql.jpg",
        },
        {
          text: "SQLite Database",
          value: "SQLITE",
          port: null,
          img: "/mix-app/assets/img/sqlite.jpg",
        },
      ],
      cultures: [],
    };
    $scope.loadSettings = async function () {
      localStorageService.remove("requests");
      localStorageService.remove("authorizationData");
      localStorageService.remove("globalSettings");
      localStorageService.remove("translator");
      localStorageService.remove("mixConfigurations");
      var getCultures = await commonService.loadJsonData("cultures");
      if (getCultures) {
        $scope.settings.cultures = getCultures.data.items;
        $scope.initCmsModel.culture = $scope.settings.cultures[0];
        $scope.dbProvider = $scope.settings.providers[0];
        $scope.initCmsModel.databaseProvider = $scope.dbProvider.value;
        $scope.initCmsModel.databasePort = $scope.dbProvider.port;
        $rootScope.isBusy = false;
        $scope.$apply();
      } else {
        if (getCultures) {
          $rootScope.showErrors(getCultures.errors);
        }
        $rootScope.isBusy = false;
        $scope.$apply();
      }
    };
    $scope.changeTypeDB = async function (type) {
      $scope.initCmsModel.isUseLocal = type;
    };

    $scope.canConnect = function () {
      return (
        ($scope.initCmsModel.databaseServer &&
          $scope.initCmsModel.databaseName &&
          $scope.initCmsModel.databaseUser &&
          $scope.initCmsModel.culture) ||
        ($scope.initCmsModel.databaseProvider == "SQLITE" &&
          $scope.initCmsModel.sqliteDbConnectionString)
      );
    };
    $scope.initCmsModel = {
      isUseLocal: false,
      localDbConnectionString:
        "Server=(localdb)\\MSSQLLocalDB;Initial Catalog=" +
        rand +
        "-mix-cms.sqlite;Integrated Security=True;Persist Security Info=False;Pooling=False;MultipleActiveResultSets=False;Encrypt=False;TrustServerCertificate=True",
      sqliteDbConnectionString: "Data Source=MixContent\\mix-cms.sqlite",
      localDbName: rand + "-mix-cms",
      databaseServer: "",
      databasePort: "",
      databaseName: "",
      databaseUser: "",
      databasePassword: "",
      adminPassword: "",
      lang: "en-us",
      isMysql: false,
      databaseProvider: "",
      culture: $scope.settings.cultures[0],
    };

    $scope.updateLocalDbName = function () {
      $scope.initCmsModel.localDbName = $scope.initCmsModel.localDbName + ".db";
      $scope.initCmsModel.localDbConnectionString =
        "Server=(localdb)\\mssqllocaldb;Database=" +
        $scope.initCmsModel.localDbName +
        ";Trusted_Connection=True;MultipleActiveResultSets=true";
      $scope.initCmsModel.sqliteDbConnectionString =
        "Data Source=" + $scope.initCmsModel.localDbName;
    };
    $scope.updateDbProvider = function () {
      $scope.initCmsModel.databaseProvider = $scope.dbProvider.value;
      $scope.initCmsModel.databasePort = $scope.dbProvider.port;
    };
    $scope.initCms = async function () {
      if (!$scope.canConnect()) {
        $rootScope.showErrors(["Please check your connection info"]);
        return;
      }
      $rootScope.isBusy = true;
      if ($scope.initCmsModel.siteName && $scope.initCmsModel.siteName != "") {
        var result = await step1Services.initCms($scope.initCmsModel);
        if (result.success) {
          $rootScope.isBusy = false;
          $rootScope.goToPath("/init/step2");
          $scope.$apply();
        } else {
          if (result) {
            $rootScope.showErrors(result.errors);
          }
          $rootScope.isBusy = false;
          $scope.$apply();
        }
      } else {
        $rootScope.showErrors(["Site name is required"]);
        $rootScope.isBusy = false;
      }
    };
  },
]);

"use strict";
app.factory("Step1Services", [
  "ApiService",
  function (apiService) {
    var step1ServiceFactory = {};
    var _initCms = async function (data) {
      var req = {
        method: "POST",
        url: "/rest/mix-tenancy/setup/init-tenant",
        data: JSON.stringify(data),
      };
      return await apiService.sendRequest(req, true);
    };

    step1ServiceFactory.initCms = _initCms;
    return step1ServiceFactory;
  },
]);

"use strict";
app.controller("Step2Controller", [
  "$scope",
  "$rootScope",
  "ApiService",
  "Step2Services",
  "AuthService",
  function ($scope, $rootScope, apiService, services, authService) {
    $scope.user = {
      username: "",
      email: "",
      password: "",
      confirmPassword: "",
      isAgreed: false,
    };
    $scope.init = async function () {
      await apiService.getGlobalSettings();
    };
    $scope.register = async function () {
      if (!$scope.user.isAgreed) {
        var ele = document.getElementById("notTNCYetChecked");
        ele.style.display = "block";
      } else {
        if ($scope.password !== $scope.confirmPassword) {
          $rootScope.showErrors(["Confirm Password is not matched"]);
        } else {
          $rootScope.isBusy = true;
          var result = await services.register($scope.user);
          if (result.success) {
            await apiService.getAllSettings();
            var loginData = {
              username: $scope.user.username,
              password: $scope.user.password,
              rememberMe: true,
            };
            var result = await authService.login(loginData, false);
            if (result.success) {
              $rootScope.isBusy = false;
              $rootScope.goToPath("/init/step3");
              $scope.$apply();
            } else {
              if (result) {
                $rootScope.showErrors(result.errors);
              }
              $rootScope.isBusy = false;
              $scope.$apply();
            }
          } else {
            if (result) {
              $rootScope.showErrors(result.errors);
            }
            $rootScope.isBusy = false;
            $scope.$apply();
          }
        }
      }
    };
    $scope.advanceSetup = async function () {
      if (!$scope.user.isAgreed) {
        var ele = document.getElementById("notTNCYetChecked");
        ele.style.display = "block";
      } else {
        if ($scope.password !== $scope.confirmPassword) {
          $rootScope.showErrors(["Confirm Password is not matched"]);
        } else {
          $rootScope.isBusy = true;
          var result = await services.register($scope.user);
          if (result.success) {
            var loginData = {
              username: $scope.user.username,
              password: $scope.user.password,
              rememberMe: true,
            };
            var result = await authService.login(loginData);
            if (result) {
              $rootScope.isBusy = false;
              $scope.$apply();
            } else {
              if (result) {
                $rootScope.showErrors(result.errors);
              }
              $rootScope.isBusy = false;
              $scope.$apply();
            }
          } else {
            if (result) {
              $rootScope.showErrors(result.errors);
            }
            $rootScope.isBusy = false;
            $scope.$apply();
          }
        }
      }
    };
  },
]);

"use strict";
app.factory("Step2Services", [
  "$http",
  "ApiService",
  "CommonService",
  function ($http, apiService, commonService) {
    //var serviceBase = 'http://ngauthenticationapi.azurewebsites.net/';

    var usersServiceFactory = {};
    var _register = async function (user) {
      var req = {
        method: "POST",
        url: "/rest/mix-tenancy/setup/init-account",
        data: JSON.stringify(user),
      };

      return await apiService.sendRequest(req, true);
    };

    usersServiceFactory.register = _register;
    return usersServiceFactory;
  },
]);

"use strict";
app.controller("Step3Controller", [
  "$scope",
  "$rootScope",
  "ApiService",
  "StoreService",
  "Step3Services",
  function ($scope, $rootScope, apiService, storeService, service) {
    var rand = Math.random();
    $scope.data = {
      isCreateDefault: true,
      theme: null,
    };
    $scope.request = {
      pageSize: "20",
      pageIndex: 0,
      status: "Published",
      orderBy: "CreatedDateTime",
      direction: "Desc",
      fromDate: null,
      toDate: null,
      postType: "theme",
    };
    $scope.themeType = "materialkit";
    $scope.init = async function () {
      await apiService.getGlobalSettings();
      $scope.form = document.getElementById("frm-theme");
      $scope.request.mixDatabaseName = "mixcoreTheme";
      var getThemes = await storeService.getThemes($scope.request);
      if (getThemes.success) {
        $scope.themes = getThemes.data;
        $scope.$apply();
      }
      $(".preventUncheck").on("change", function (e) {
        if ($(".preventUncheck:checked").length == 0 && !this.checked)
          this.checked = true;
      });
      $(".option").click(function () {
        $(".option").removeClass("active");
        $(this).addClass("active");
      });
    };
    $scope.submit = async function () {
      let theme = $scope.form["theme"].files[0];
      if ($scope.mode === "Upload your theme" && !theme) {
        $rootScope.showErrors(["Please select theme file"]);
        return;
      }
      $rootScope.isBusy = true;
      var frm = new FormData();
      var url = "/rest/mix-tenancy/setup/extract-theme";
      $scope.data.isCreateDefault = $scope.themeType === "materialkit";
      $rootScope.isBusy = true;
      // Looping over all files and add it to FormData object
      frm.append("theme", theme);
      // Adding one more key to FormData object
      frm.append("model", angular.toJson($scope.data));
      var response = await service.ajaxSubmitForm(frm, url);
      $rootScope.isBusy = false;
      if (response.success) {
        $rootScope.goToPath("/init/step4");
        $scope.$apply();
      } else {
        $rootScope.showErrors(response.errors);
        $rootScope.isBusy = false;
        $scope.$apply();
      }
    };
    $scope.install = function (resp) {
      if (resp.success) {
        $rootScope.goToPath("/init/step4");
      } else {
        $rootScope.showErrors(["Cannot install theme"]);
      }
    };
    $scope.selectPane = function (pane) {
      $scope.canContinue = pane.header !== "Mixcore Store";
      $scope.mode = pane.header;
    };
  },
]);

"use strict";
app.factory("Step3Services", [
  "ApiService",
  function (apiService) {
    var service = {};
    var _submit = async function (data) {
      var req = {
        method: "POST",
        url: "/init/init-cms/step-3",
        data: JSON.stringify(data),
      };
      return await apiService.sendRequest(req);
    };
    var _activeTheme = async function (data) {
      var req = {
        method: "POST",
        url: "/init/init-cms/step-3/active",
        data: JSON.stringify(data),
      };
      return await apiService.sendRequest(req);
    };
    var _ajaxSubmitForm = async function (form, url) {
      var req = {
        method: "POST",
        url: url,
        headers: { "Content-Type": undefined },
        contentType: false, // Not to set any content header
        processData: false, // Not to process data
        data: form,
      };
      return await apiService.sendRequest(req);
    };
    service.submit = _submit;
    service.activeTheme = _activeTheme;
    service.ajaxSubmitForm = _ajaxSubmitForm;
    return service;
  },
]);

"use strict";
app.controller("Step4Controller", [
  "$scope",
  "$rootScope",
  "ApiService",
  "AuthService",
  "Step4Services",
  function ($scope, $rootScope, apiService, authService, service) {
    $scope.importThemeDto = null;
    $scope.canContinue = true;
    $scope.data = [];
    $scope.init = async function () {
      await apiService.getGlobalSettings();
      var getData = await service.loadTheme();
      if (getData.success) {
        $scope.importThemeDto = getData.data;
        $rootScope.isBusy = false;
        $scope.$apply();
      }
    };
    $scope.submit = async function () {
      $rootScope.isBusy = true;
      var result = await service.submit($scope.importThemeDto);
      if (result.success) {
        window.top.location = "/";
      } else {
        if (result) {
          $rootScope.showErrors(result.errors);
        }
        $rootScope.isBusy = false;
        $scope.$apply();
      }
    };
  },
]);

"use strict";
app.factory("Step4Services", [
  "ApiService",
  "CommonService",
  function (apiService, commonService) {
    var service = {};

    var _loadTheme = async function () {
      var req = {
        method: "GET",
        url: "/rest/mix-tenancy/setup/load-theme",
      };
      return await apiService.sendRequest(req);
    };
    var _submit = async function (data) {
      var req = {
        method: "POST",
        url: "/rest/mix-tenancy/setup/import-theme",
        data: JSON.stringify(data),
      };
      return await apiService.sendRequest(req);
    };
    service.loadTheme = _loadTheme;
    service.submit = _submit;
    return service;
  },
]);

"use strict";
app.controller("Step5Controller", [
  "$scope",
  "$rootScope",
  "$location",
  "ApiService",
  "CommonService",
  "Step5Services",
  function ($scope, $rootScope, $location, apiService, commonService, service) {
    var rand = Math.random();
    $scope.data = [];
    $scope.init = async function () {
      var getData = await commonService.loadJsonData("configurations");
      if (getData.success) {
        $scope.data = getData.data.items;
        $rootScope.isBusy = false;
        $scope.$apply();
      } else {
        if (getData) {
          $rootScope.showErrors(getData.errors);
        }
        $rootScope.isBusy = false;
        $scope.$apply();
      }
    };
    $scope.submit = async function () {
      $rootScope.isBusy = true;
      var result = await service.submit($scope.data);
      if (result.success) {
        $rootScope.isBusy = false;
        window.top.location = "/";
      } else {
        if (result) {
          $rootScope.showErrors(result.errors);
        }
        $rootScope.isBusy = false;
      }
    };
  },
]);

"use strict";
app.factory("Step5Services", [
  "ApiService",
  "CommonService",
  function (apiService, commonService) {
    //var serviceBase = 'http://ngauthenticationapi.azurewebsites.net/';

    var service = {};
    var _submit = async function (data) {
      var req = {
        method: "POST",
        url: "/init/init-cms/step-5",
        data: JSON.stringify(data),
      };
      return await apiService.sendRequest(req);
    };
    service.submit = _submit;
    return service;
  },
]);

modules.component("mssqlInfo", {
  templateUrl:
    "/mix-app/views/app-init/pages/step1/components/mssql-info/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
    },
  ],
  bindings: {
    initCmsModel: "=",
  },
});

modules.component("mssqlLocalInfo", {
  templateUrl:
    "/mix-app/views/app-init/pages/step1/components/mssql-local-info/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
    },
  ],
  bindings: {
    initCmsModel: "=",
  },
});

modules.component("mysqlInfo", {
  templateUrl:
    "/mix-app/views/app-init/pages/step1/components/mysql-info/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
    },
  ],
  bindings: {
    initCmsModel: "=",
  },
});

modules.component("posgresqlInfo", {
  templateUrl:
    "/mix-app/views/app-init/pages/step1/components/posgresql-info/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
    },
  ],
  bindings: {
    initCmsModel: "=",
  },
});

modules.component("sqliteInfo", {
  templateUrl:
    "/mix-app/views/app-init/pages/step1/components/sqlite-info/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
    },
  ],
  bindings: {
    initCmsModel: "=",
  },
});

app.component("themeImportMixDatabases", {
  templateUrl:
    "/mix-app/views/app-init/pages/step4/components/theme-import-mix-databases/view.html",
  bindings: {
    importThemeDto: "=",
  },
  controller: [
    "$rootScope",
    "$scope",
    "ngAppSettings",
    "RestMixDatabasePortalService",
    function ($rootScope, $scope, ngAppSettings, service) {
      var ctrl = this;
      ctrl.selectAllContent = false;
      ctrl.selectAllData = false;
      ctrl.request = angular.copy(ngAppSettings.request);
      ctrl.$onInit = async () => {
        // ctrl.getList();
      };
      ctrl.getList = async (pageIndex) => {
        if (pageIndex !== undefined) {
          ctrl.request.pageIndex = pageIndex;
        }
        if (ctrl.request.fromDate !== null) {
          var d = new Date(ctrl.request.fromDate);
          ctrl.request.fromDate = d.toISOString();
        }
        if (ctrl.request.toDate !== null) {
          var d = new Date(ctrl.request.toDate);
          ctrl.request.toDate = d.toISOString();
        }
        let getData = await service.getList(ctrl.request);
        if (getData.success) {
          ctrl.data = getData.data;
        }
      };
      ctrl.selectContent = (mixDatabase, selected) => {
        ctrl.selectAllContent = ctrl.selectAllContent && selected;
        ctrl.selectAllData = ctrl.selectAllData && selected;
        mixDatabase.isImportData = selected && mixDatabase.isImportData;
        ctrl.updateContent([mixDatabase.id], selected);
      };
      ctrl.selectData = (mixDatabase, selected) => {
        ctrl.selectAllData = ctrl.selectAllData && selected;
        ctrl.updateData([mixDatabase.id], selected);
      };
      ctrl.updateContent = function (arr, selected) {
        if (selected) {
          ctrl.importThemeDto.content.mixDatabaseIds = ctrl.unionArray(
            ctrl.importThemeDto.content.mixDatabaseIds,
            arr
          );
        } else {
          ctrl.importThemeDto.content.mixDatabaseIds =
            ctrl.importThemeDto.content.mixDatabaseIds.filter(
              (m) => arr.indexOf(m) < 0
            );
          ctrl.updateData(arr, false);
        }
      };
      ctrl.updateData = function (arr, selected) {
        if (selected) {
          ctrl.importThemeDto.data.mixDatabaseIds = ctrl.unionArray(
            ctrl.importThemeDto.data.mixDatabaseIds,
            arr
          );
        } else {
          ctrl.importThemeDto.data.mixDatabaseIds =
            ctrl.importThemeDto.data.mixDatabaseIds.filter(
              (m) => arr.indexOf(m) < 0
            );
        }
      };
      ctrl.selectAll = function (arr) {
        // ctrl.selectedList.data = [];
        var ids = arr.map(function (obj) {
          return obj.id;
        });
        ctrl.updateContent(ids, ctrl.selectAllContent);
        ctrl.updateData(ids, ctrl.selectAllData);
        angular.forEach(arr, function (e) {
          e.isActived = ctrl.selectAllContent;
          e.isImportData = ctrl.selectAllData;
        });
      };
      ctrl.unionArray = (a, b) => {
        return [...new Set([...a, ...b])];
      };
    },
  ],
});

app.component("themeImportModules", {
  templateUrl:
    "/mix-app/views/app-init/pages/step4/components/theme-import-modules/view.html",
  controller: [
    "$rootScope",
    "$scope",
    "ngAppSettings",
    function ($rootScope, $scope, ngAppSettings) {
      var ctrl = this;
      var service = $rootScope.getRestService("mix-module");
      ctrl.selectAllContent = false;
      ctrl.selectAllData = false;
      ctrl.request = angular.copy(ngAppSettings.request);
      ctrl.$onInit = async () => {
        // ctrl.getList();
      };
      ctrl.getList = async (moduleIndex) => {
        if (moduleIndex !== undefined) {
          ctrl.request.moduleIndex = moduleIndex;
        }
        if (ctrl.request.fromDate !== null) {
          var d = new Date(ctrl.request.fromDate);
          ctrl.request.fromDate = d.toISOString();
        }
        if (ctrl.request.toDate !== null) {
          var d = new Date(ctrl.request.toDate);
          ctrl.request.toDate = d.toISOString();
        }
        let getData = await service.getList(ctrl.request);
        if (getData.success) {
          ctrl.data = getData.data;
        }
      };
      ctrl.selectContent = (module, selected) => {
        ctrl.selectAllContent = ctrl.selectAllContent && selected;
        ctrl.selectAllData = ctrl.selectAllData && selected;
        module.isImportData = selected && module.isImportData;
        let contentIds = module.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.content.moduleIds = ctrl.updateArray(
          ctrl.importThemeDto.content.moduleIds,
          [module.id],
          selected
        );
        ctrl.importThemeDto.content.moduleContentIds = ctrl.updateArray(
          ctrl.importThemeDto.content.moduleContentIds,
          contentIds,
          selected
        );
        if (!selected) {
          ctrl.selectData(module, false);
        }
      };
      ctrl.selectData = (module, selected) => {
        ctrl.selectAllData = ctrl.selectAllData && selected;
        let contentIds = module.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.associations.moduleIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.moduleIds,
          [module.id],
          selected
        );
        ctrl.importThemeDto.associations.moduleContentIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.moduleContentIds,
          contentIds,
          selected
        );
      };
      ctrl.updateArray = function (src, arr, selected) {
        if (selected) {
          src = ctrl.unionArray(src, arr);
        } else {
          src = src.filter((m) => arr.indexOf(m) < 0);
        }
        return src;
      };
      ctrl.selectAll = function (arr) {
        angular.forEach(arr, function (e) {
          ctrl.selectContent(e, ctrl.selectAllContent);
          ctrl.selectData(e, ctrl.selectAllData);
          e.isActived = ctrl.selectAllContent;
          e.isImportData = ctrl.selectAllData;
        });
      };
      ctrl.unionArray = (a, b) => {
        return [...new Set([...a, ...b])];
      };
    },
  ],
  bindings: {
    importThemeDto: "=",
  },
});

app.component("themeImportPages", {
  templateUrl:
    "/mix-app/views/app-init/pages/step4/components/theme-import-pages/view.html",
  controller: [
    "$rootScope",
    "$scope",
    "ngAppSettings",
    function ($rootScope, $scope, ngAppSettings) {
      var ctrl = this;
      var service = $rootScope.getRestService("mix-page");
      ctrl.selectAllContent = false;
      ctrl.selectAllData = false;
      ctrl.request = angular.copy(ngAppSettings.request);
      ctrl.$onInit = async () => {
        // ctrl.getList();
      };
      ctrl.getList = async (pageIndex) => {
        if (pageIndex !== undefined) {
          ctrl.request.pageIndex = pageIndex;
        }
        if (ctrl.request.fromDate !== null) {
          var d = new Date(ctrl.request.fromDate);
          ctrl.request.fromDate = d.toISOString();
        }
        if (ctrl.request.toDate !== null) {
          var d = new Date(ctrl.request.toDate);
          ctrl.request.toDate = d.toISOString();
        }
        let getData = await service.getList(ctrl.request);
        if (getData.success) {
          ctrl.data = getData.data;
        }
      };
      ctrl.selectContent = (page, selected) => {
        ctrl.selectAllContent = ctrl.selectAllContent && selected;
        ctrl.selectAllData = ctrl.selectAllData && selected;
        page.isImportData = selected && page.isImportData;
        let contentIds = page.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.content.pageIds = ctrl.updateArray(
          ctrl.importThemeDto.content.pageIds,
          [page.id],
          selected
        );
        ctrl.importThemeDto.content.pageContentIds = ctrl.updateArray(
          ctrl.importThemeDto.content.pageContentIds,
          contentIds,
          selected
        );
        if (!selected) {
          ctrl.selectData(page, false);
        }
      };
      ctrl.selectData = (page, selected) => {
        ctrl.selectAllData = ctrl.selectAllData && selected;
        let contentIds = page.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.associations.pageIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.pageIds,
          [page.id],
          selected
        );
        ctrl.importThemeDto.associations.pageContentIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.pageContentIds,
          contentIds,
          selected
        );
      };
      ctrl.updateArray = function (src, arr, selected) {
        if (selected) {
          src = ctrl.unionArray(src, arr);
        } else {
          src = src.filter((m) => arr.indexOf(m) < 0);
        }
        return src;
      };
      ctrl.selectAll = function (arr) {
        angular.forEach(arr, function (e) {
          ctrl.selectContent(e, ctrl.selectAllContent);
          ctrl.selectData(e, ctrl.selectAllData);
          e.isActived = ctrl.selectAllContent;
          e.isImportData = ctrl.selectAllData;
        });
      };
      ctrl.unionArray = (a, b) => {
        return [...new Set([...a, ...b])];
      };
    },
  ],
  bindings: {
    importThemeDto: "=",
  },
});

app.component("themeImportPosts", {
  templateUrl:
    "/mix-app/views/app-init/pages/step4/components/theme-import-posts/view.html",
  controller: [
    "$rootScope",
    "$scope",
    "ngAppSettings",
    function ($rootScope, $scope, ngAppSettings) {
      var ctrl = this;
      var service = $rootScope.getRestService("mix-post");
      ctrl.selectAllContent = false;
      ctrl.selectAllData = false;
      ctrl.request = angular.copy(ngAppSettings.request);
      ctrl.$onInit = async () => {
        // ctrl.getList();
      };
      ctrl.getList = async (postIndex) => {
        if (postIndex !== undefined) {
          ctrl.request.postIndex = postIndex;
        }
        if (ctrl.request.fromDate !== null) {
          var d = new Date(ctrl.request.fromDate);
          ctrl.request.fromDate = d.toISOString();
        }
        if (ctrl.request.toDate !== null) {
          var d = new Date(ctrl.request.toDate);
          ctrl.request.toDate = d.toISOString();
        }
        let getData = await service.getList(ctrl.request);
        if (getData.success) {
          ctrl.data = getData.data;
        }
      };
      ctrl.selectContent = (post, selected) => {
        ctrl.selectAllContent = ctrl.selectAllContent && selected;
        ctrl.selectAllData = ctrl.selectAllData && selected;
        post.isImportData = selected && post.isImportData;
        let contentIds = post.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.content.postIds = ctrl.updateArray(
          ctrl.importThemeDto.content.postIds,
          [post.id],
          selected
        );
        ctrl.importThemeDto.content.postContentIds = ctrl.updateArray(
          ctrl.importThemeDto.content.postContentIds,
          contentIds,
          selected
        );
        if (!selected) {
          ctrl.selectData(post, false);
        }
      };
      ctrl.selectData = (post, selected) => {
        ctrl.selectAllData = ctrl.selectAllData && selected;
        let contentIds = post.contents.map(function (obj) {
          return obj.id;
        });
        ctrl.importThemeDto.associations.postIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.postIds,
          [post.id],
          selected
        );
        ctrl.importThemeDto.associations.postContentIds = ctrl.updateArray(
          ctrl.importThemeDto.associations.postContentIds,
          contentIds,
          selected
        );
      };
      ctrl.updateArray = function (src, arr, selected) {
        if (selected) {
          src = ctrl.unionArray(src, arr);
        } else {
          src = src.filter((m) => arr.indexOf(m) < 0);
        }
        return src;
      };
      ctrl.selectAll = function (arr) {
        angular.forEach(arr, function (e) {
          ctrl.selectContent(e, ctrl.selectAllContent);
          ctrl.selectData(e, ctrl.selectAllData);
          e.isActived = ctrl.selectAllContent;
          e.isImportData = ctrl.selectAllData;
        });
      };
      ctrl.unionArray = (a, b) => {
        return [...new Set([...a, ...b])];
      };
    },
  ],
  bindings: {
    importThemeDto: "=",
  },
});

app.component("initFbConfigurations", {
  templateUrl:
    "/mix-app/views/app-init/pages/step3/components/fb-configurations/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
      ctrl.data = [];
      ctrl.$onInit = function () {
        ctrl.data = $rootScope.filterArray(
          ctrl.configurations,
          ["category"],
          ["Social_Facebook"]
        );
      };
    },
  ],
  bindings: {
    configurations: "=",
  },
});

app.component("initGgConfigurations", {
  templateUrl:
    "/mix-app/views/app-init/pages/step3/components/gg-configurations/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
      ctrl.data = [];
      ctrl.$onInit = function () {
        ctrl.data = $rootScope.filterArray(
          ctrl.configurations,
          ["category"],
          ["Social_Google"]
        );
      };
    },
  ],
  bindings: {
    configurations: "=",
  },
});

modules.component("initValueEditor", {
  templateUrl:
    "/mix-app/views/app-init/pages/step3/components/init-value-editor/view.html",
  controller: [
    "$rootScope",
    "$scope",
    "ngAppSettings",
    "FileService",
    function ($rootScope, $scope, ngAppSettings, fileService) {
      var ctrl = this;
      ctrl.icons = ngAppSettings.icons;
      ctrl.mediaFile = {
        file: null,
        fullPath: "",
        fileFolder: "content/site",
        title: "",
        description: "",
      };
      this.dataTypes = ngAppSettings.dataTypes;
      ctrl.initEditor = function () {
        ctrl.data.value = ctrl.data.default || null;
        setTimeout(function () {
          // Init Code editor
          $.each($(".code-editor"), function (i, e) {
            var container = $(this);
            var editor = ace.edit(e);
            if (container.hasClass("json")) {
              editor.session.setMode("ace/mode/json");
            } else {
              editor.session.setMode("ace/mode/razor");
            }
            editor.setTheme("ace/theme/chrome");
            //editor.setReadOnly(true);

            editor.session.setUseWrapMode(true);
            editor.setOptions({
              maxLines: Infinity,
            });
            editor.getSession().on("change", function (e) {
              // e.type, etc
              $(container)
                .parent()
                .find(".code-content")
                .val(editor.getValue());
            });
          });
          $.each($(".editor-content"), function (i, e) {
            var $demoTextarea = $(e);
            $demoTextarea
              .trumbowyg({
                semantic: false,
              })
              .on("tbwblur", function () {
                ctrl.data.value = $demoTextarea.val();
              });
          });
        }, 200);
      };
      ctrl.selectFile = function (file, errFiles) {
        if (file !== undefined && file !== null) {
          ctrl.mediaFile.folder = ctrl.folder ? ctrl.folder : "Media";
          ctrl.mediaFile.title = ctrl.title ? ctrl.title : "";
          ctrl.mediaFile.description = ctrl.description ? ctrl.description : "";
          ctrl.mediaFile.file = file;

          ctrl.uploadFile(file);
        }
      };
      ctrl.uploadFile = async function (file) {
        if (file !== null) {
          $rootScope.isBusy = true;
          var reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = async function () {
            ctrl.mediaFile.fileName = file.name.substring(
              0,
              file.name.lastIndexOf(".")
            );
            ctrl.mediaFile.extension = file.name.substring(
              file.name.lastIndexOf(".")
            );
            ctrl.mediaFile.fileStream = reader.result;
            var resp = await fileService.save(ctrl.mediaFile);
            if (resp && resp.success) {
              ctrl.data.value = resp.data.webPath;
              ctrl.srcUrl = resp.data.webPath;
              $rootScope.isBusy = false;
              $scope.$apply();
            } else {
              if (resp) {
                $rootScope.showErrors(resp.errors);
              }
              $rootScope.isBusy = false;
              $scope.$apply();
            }
          };
          reader.onerror = function (error) {};
        } else {
          return null;
        }
      };
    },
  ],
  bindings: {
    data: "=",
    inputClass: "=",
    isShowTitle: "=",
    title: "=",
  },
});

app.component("initSiteConfigurations", {
  templateUrl:
    "/mix-app/views/app-init/pages/step3/components/site-configurations/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
      ctrl.data = [];
      ctrl.$onInit = function () {
        ctrl.data = $rootScope.filterArray(
          ctrl.configurations,
          ["category"],
          ["Site_Common"]
        );
      };
    },
  ],
  bindings: {
    configurations: "=",
  },
});

app.component("initSysConfigurations", {
  templateUrl:
    "/mix-app/views/app-init/pages/step3/components/site-configurations/view.html",
  controller: [
    "$rootScope",
    function ($rootScope) {
      var ctrl = this;
      ctrl.data = [];
      ctrl.$onInit = function () {
        ctrl.data = $rootScope.filterArray(
          ctrl.configurations,
          ["category"],
          ["System"]
        );
      };
    },
  ],
  bindings: {
    configurations: "=",
  },
});
